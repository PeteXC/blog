<!doctype html><html lang=en><head><title>How to create an AWS WAF in Go CDK ::
Pete's Blog — Yet another programmer's blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Recently I&amp;rsquo;ve been creating some custom AWS WAF rules to workaround the not so well known AWS WAF limit of 8 kilobytes on the inspection of web request bodies.
To start with, a WAF is a Web Application Firewall. It&amp;rsquo;s a layer that scans and monitors the HTTP requests between your content distribution network (CDN) and the rest of the internet. Typically it sits on top of Cloudfront if we&amp;rsquo;re talking about AWS."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://petexc.github.io/blog/posts/how-to-create-aws-web-acl-rules-in-go/><link rel=stylesheet href=https://petexc.github.io/blog/assets/style.css><link rel=stylesheet href=https://petexc.github.io/blog/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://petexc.github.io/blog/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://petexc.github.io/blog/img/favicon.png><link href=https://petexc.github.io/blog/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://petexc.github.io/blog/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://petexc.github.io/blog/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://petexc.github.io/blog/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://petexc.github.io/blog/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://petexc.github.io/blog/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="How to create an AWS WAF in Go CDK"><meta name=twitter:description content="A short guide on how to create an AWS WAF and write custom web ACL rules in Go CDK"><meta property="og:title" content="How to create an AWS WAF in Go CDK"><meta property="og:description" content="A short guide on how to create an AWS WAF and write custom web ACL rules in Go CDK"><meta property="og:type" content="article"><meta property="og:url" content="https://petexc.github.io/blog/posts/how-to-create-aws-web-acl-rules-in-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-29T20:03:56+01:00"><meta property="article:modified_time" content="2022-04-29T20:03:56+01:00"><meta property="og:site_name" content="Pete's Blog"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/posts class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>pete@blog:~$</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/blog/about>About</a></li><li><a href=/blog/archive>Archive</a></li><li><a href=/blog/showcase>Showcase</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/blog/about>About</a></li><li><a href=/blog/archive>Archive</a></li><li><a href=/blog/showcase>Showcase</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>How to create an AWS WAF in Go CDK</h1><div class=post-meta><span class=post-date>2022-04-29</span>
<span class=post-author>— Written by Peter C</span></div><figure class=post-cover><img src=https://petexc.github.io/img/rules.jpg alt="How to create an AWS WAF in Go CDK"><figcaption class=center>Photo by Kyle Glenn on Unsplash</figcaption></figure><div class=post-content><p>Recently I&rsquo;ve been creating some custom AWS WAF rules to workaround the not so well known <a href=https://docs.aws.amazon.com/waf/latest/developerguide/web-request-body-inspection.html>AWS WAF limit</a> of 8 kilobytes on the inspection of web request bodies.</p><p>To start with, a WAF is a Web Application Firewall. It&rsquo;s a layer that scans and monitors the HTTP requests between your content distribution network (CDN) and the rest of the internet. Typically it sits on top of Cloudfront if we&rsquo;re talking about AWS.</p><p>You can configure a WAF with rules that will dictate the behaviour of the firewall. Block some requests if theses conditions are met&mldr; Allow these other requsts if these other conditions are met&mldr; etc</p><p>If you&rsquo;re reading this post, you will likely already have a good understanding of all of this anyways so I&rsquo;ll just cut to the chase. How can one use AWS CDK to create a WAF?</p><h2 id=create-a-cdk-project>Create a CDK project
<a href=#create-a-cdk-project class=h-anchor aria-hidden=true>#</a></h2><p>Let&rsquo;s start by creating an empty cdk.go file and run the following to initialise a go module for this project with <code>go mod init</code></p><p>We can start by importing the Go CDK package for AWS WAF at <a href=https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awswafv2>awswafv2</a> right into our cdk.go file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> 	<span style=color:#e6db74>&#34;github.com/aws/aws-cdk-go/awscdk/v2/awswafv2&#34;</span>
</span></span></code></pre></div><p>Or you could use the older version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/aws/aws-cdk-go/awscdk/awswafv2&#34;</span>
</span></span></code></pre></div><p>and some code to get you started:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>app</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>awscdk</span>.<span style=color:#a6e22e>NewApp</span>(<span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stack</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>awscdk</span>.<span style=color:#a6e22e>NewStack</span>(<span style=color:#a6e22e>app</span>, <span style=color:#e6db74>&#34;WAFStack&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CDNStackProps</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>StackProps</span>: <span style=color:#a6e22e>awscdk</span>.<span style=color:#a6e22e>StackProps</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Env</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>awscdk</span>.<span style=color:#a6e22e>Environment</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Account</span>: <span style=color:#a6e22e>jsii</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;{Your account here}&#34;</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Region</span>:  <span style=color:#a6e22e>jsii</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;us-east-1&#34;</span>)
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>Synth</span>(<span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that WAFs bound for Cloudfront distributions <a href=https://docs.aws.amazon.com/waf/latest/developerguide/how-aws-waf-works.html>must be in us-east-1</a> at the writing of this article.</p><h2 id=create-a-waf>Create a WAF
<a href=#create-a-waf class=h-anchor aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createWAF</span>(<span style=color:#a6e22e>stack</span> <span style=color:#a6e22e>awscdk</span>.<span style=color:#a6e22e>Stack</span>, <span style=color:#a6e22e>rules</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>awswafv2</span>.<span style=color:#a6e22e>NewCfnWebACL</span>(<span style=color:#a6e22e>stack</span>, <span style=color:#a6e22e>jsii</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;MyWebACLId&#34;</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>awswafv2</span>.<span style=color:#a6e22e>CfnWebACLProps</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:  <span style=color:#a6e22e>jsii</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;MyWebACLName&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Scope</span>: <span style=color:#a6e22e>jsii</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;CLOUDFRONT&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>DefaultAction</span>: <span style=color:#a6e22e>awswafv2</span>.<span style=color:#a6e22e>CfnWebACL_DefaultActionProperty</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Allow</span>: <span style=color:#66d9ef>struct</span>{}{},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>VisibilityConfig</span>: <span style=color:#a6e22e>awswafv2</span>.<span style=color:#a6e22e>CfnWebACL_VisibilityConfigProperty</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>SampledRequestsEnabled</span>:   <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>CloudWatchMetricsEnabled</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>MetricName</span>:               <span style=color:#a6e22e>jsii</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;MyWebACLName&#34;</span>),
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Rules</span>: <span style=color:#a6e22e>rules</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now call this method in your main method before <code>app.Synth(nil)</code> and you&rsquo;re golden!</p><p>But hold-up, you still haven&rsquo;t got any rules to add to your web ACL!</p><h2 id=create-rules-for-the-web-acl>Create rules for the Web ACL
<a href=#create-rules-for-the-web-acl class=h-anchor aria-hidden=true>#</a></h2><p>To understand how Web ACL rule priority works read <a href=https://docs.aws.amazon.com/waf/latest/developerguide/web-acl-processing-order.html>this</a> and for how rules work in general the <a href=https://docs.aws.amazon.com/waf/latest/developerguide/waf-rules.html>AWS docs</a> I would recommend reading. It&rsquo;s fairly straighforward and the basic structure of a rule looks like this</p><ol><li>Statement</li><li>Action</li><li>Priority</li></ol></div></div></div><footer class=footer><div class=footer__inner><a href=/posts class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>pete@blog:~$</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://petexc.github.io/blog/assets/main.js></script>
<script src=https://petexc.github.io/blog/assets/prism.js></script></div></body></html>